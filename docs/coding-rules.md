# コーディングルール

本リポジトリでは **Ultracite**（Biome ベース）を使用してフォーマット・リントを自動化している。

```bash
npm run fix      # 自動修正
npm run check    # チェックのみ
```

---

## フォーマット

| 項目 | 設定値 |
|---|---|
| インデント | タブ |
| 改行コード | LF |
| セミコロン | あり |
| アロー関数の括弧 | 常にあり `(x) => ...` |

---

## TypeScript ルール

### 型安全性

- 関数のパラメータ・戻り値には明確さを高める場合に明示的な型を付ける
- 型が不明な場合は `any` ではなく `unknown` を使う
- 不変値・リテラル型には `as const` を使う
- 型アサーションより型の絞り込み（narrowing）を優先する
- マジックナンバーは避け、説明的な名前の定数に切り出す

### モダン JavaScript/TypeScript

- コールバックや短い関数にはアロー関数を使う
- `forEach` 禁止 → `for...of` を使う
- オプショナルチェーン（`?.`）・Null 合体演算子（`??`）を推奨
- 文字列結合よりテンプレートリテラルを優先
- オブジェクト・配列の代入には分割代入を使う
- `const` をデフォルトに、再代入が必要な場合のみ `let`、`var` は禁止

### 非同期処理

- async 関数内の Promise は必ず `await` する
- Promise チェーンより `async/await` を使う
- async コードでは `try-catch` で適切にエラーハンドリングする
- Promise executor に async 関数を使わない

### エラーハンドリング

- プロダクションコードに `console.log`・`debugger`・`alert` を残さない
- 文字列ではなく `Error` オブジェクトを throw する
- 再 throw するだけの無意味な `try-catch` は避ける
- ネストした条件分岐より早期 return を優先する

### コード構成

- 関数は認知的複雑度を適切に保つ
- 複雑な条件は名前付きの boolean 変数に切り出す
- 早期 return でネストを減らす
- ネストした三項演算子禁止
- 関連するコードをまとめ、関心事を分離する

### パフォーマンス

- ループ内でのスプレッド蓄積（`...spread`）禁止
- ループ内での正規表現生成を避け、トップレベルのリテラルを使う
- 名前空間 import より個別 import を優先
- バレルファイル（`index.ts` で re-export）禁止

### セキュリティ

- `target="_blank"` には `rel="noopener"` を付ける
- React での生の HTML 注入は避ける（サニタイズ済みコンテンツを使用）
- 動的コード実行パターンは禁止
- ユーザー入力はバリデーション・サニタイズする

### スタイル

- **`enum` 禁止** → ユニオン型や `as const` を使う
- **非 null アサーション（`!`）禁止**
- 型定義は `type` より **`interface`** を優先
- ファイル名は **kebab-case**（ASCII 必須）
- `import type` / `export type` を適切に使う
- ブロック文（`{}`）を常に使用（省略禁止）
- `==` 禁止 → `===` を使う
- `@ts-ignore` 禁止 → `@ts-expect-error` を使う
- 空のブロック文禁止

---

## React & JSX

- 関数コンポーネントを使う（クラスコンポーネント禁止）
- Hook はトップレベルでのみ呼び出す（条件付き呼び出し禁止）
- Hook の依存配列を正確に指定する
- イテラブル内の要素には `key` を指定（配列インデックスよりユニーク ID）
- 子要素は開閉タグの間にネストする（props として渡さない）
- コンポーネント内で別のコンポーネントを定義しない
- セマンティック HTML と ARIA 属性を使う
- React 19+: `React.forwardRef` の代わりに ref を props として渡す

---

## テスト

- アサーションは `it()` / `test()` ブロック内に書く
- async テストでは done コールバックを使わず `async/await` を使う
- `.only` / `.skip` をコミットしない
- `describe` の過剰なネストを避ける

---

## ファイル別の例外

| 対象 | 緩和ルール |
|---|---|
| テストファイル（`*.test.*`, `*.spec.*`） | 認知的複雑度・`console`・`any` を許可 |
| スクリプト（`scripts/`） | `console`・`process.env` を許可 |
| 型定義ファイル（`*.d.ts`） | 未使用変数・未宣言変数を許可 |

---

## Biome で検出できない項目

自動リントでカバーできない以下の点に注意する：

1. **ビジネスロジックの正確性** — アルゴリズムの妥当性
2. **命名** — 関数・変数・型に説明的な名前を付ける
3. **アーキテクチャ** — コンポーネント構成・データフロー・API 設計
4. **エッジケース** — 境界条件・エラー状態の処理
5. **ドキュメント** — 複雑なロジックにはコメントを付ける（自己文書化を優先）
